<!DOCTYPE html PUBLIC ""
    "">
<html><head><meta charset="UTF-8" /><title>tech.v3.dataset.sql documentation</title><link rel="stylesheet" type="text/css" href="css/default.css" /><link rel="stylesheet" type="text/css" href="highlight/solarized-light.css" /><script type="text/javascript" src="highlight/highlight.min.js"></script><script type="text/javascript" src="js/jquery.min.js"></script><script type="text/javascript" src="js/page_effects.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a> with <a href="https://github.com/xsc/codox-theme-rdash">RDash UI</a> theme</h2><h1><a href="index.html"><span class="project-title"><span class="project-name"></span> <span class="project-version">6.044-00</span></span></a></h1></div><div class="sidebar primary"><h3 class="no-link"><span class="inner">Project</span></h3><ul class="index-link"><li class="depth-1 "><a href="index.html"><div class="inner">Index</div></a></li></ul><h3 class="no-link"><span class="inner">Namespaces</span></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>tech</span></div></div></li><li class="depth-2"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>v3</span></div></div></li><li class="depth-3"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>dataset</span></div></div></li><li class="depth-4 current"><a href="tech.v3.dataset.sql.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>sql</span></div></a></li><li class="depth-5"><a href="tech.v3.dataset.sql.datatypes.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>datatypes</span></div></a></li></ul></div><div class="sidebar secondary"><h3><a href="#top"><span class="inner">Public Vars</span></a></h3><ul><li class="depth-1"><a href="tech.v3.dataset.sql.html#var-create-sql"><div class="inner"><span>create-sql</span></div></a></li><li class="depth-1"><a href="tech.v3.dataset.sql.html#var-create-table.21"><div class="inner"><span>create-table!</span></div></a></li><li class="depth-1"><a href="tech.v3.dataset.sql.html#var-database-name"><div class="inner"><span>database-name</span></div></a></li><li class="depth-1"><a href="tech.v3.dataset.sql.html#var-database-type-table"><div class="inner"><span>database-type-table</span></div></a></li><li class="depth-1"><a href="tech.v3.dataset.sql.html#var-drop-table.21"><div class="inner"><span>drop-table!</span></div></a></li><li class="depth-1"><a href="tech.v3.dataset.sql.html#var-drop-table-when-exists.21"><div class="inner"><span>drop-table-when-exists!</span></div></a></li><li class="depth-1"><a href="tech.v3.dataset.sql.html#var-ensure-table.21"><div class="inner"><span>ensure-table!</span></div></a></li><li class="depth-1"><a href="tech.v3.dataset.sql.html#var-execute-prepared-statement-batches.21"><div class="inner"><span>execute-prepared-statement-batches!</span></div></a></li><li class="depth-1"><a href="tech.v3.dataset.sql.html#var-execute-update.21"><div class="inner"><span>execute-update!</span></div></a></li><li class="depth-1"><a href="tech.v3.dataset.sql.html#var-generic-column-.3Esql"><div class="inner"><span>generic-column-&gt;sql</span></div></a></li><li class="depth-1"><a href="tech.v3.dataset.sql.html#var-generic-sql-.3Ecolumn"><div class="inner"><span>generic-sql-&gt;column</span></div></a></li><li class="depth-1"><a href="tech.v3.dataset.sql.html#var-insert-dataset.21"><div class="inner"><span>insert-dataset!</span></div></a></li><li class="depth-1"><a href="tech.v3.dataset.sql.html#var-insert-sql"><div class="inner"><span>insert-sql</span></div></a></li><li class="depth-1"><a href="tech.v3.dataset.sql.html#var-make-convert-column-.3Esql"><div class="inner"><span>make-convert-column-&gt;sql</span></div></a></li><li class="depth-1"><a href="tech.v3.dataset.sql.html#var-make-convert-sql-.3Ecolumn"><div class="inner"><span>make-convert-sql-&gt;column</span></div></a></li><li class="depth-1"><a href="tech.v3.dataset.sql.html#var-postgre-sql-connect-str"><div class="inner"><span>postgre-sql-connect-str</span></div></a></li><li class="depth-1"><a href="tech.v3.dataset.sql.html#var-postgres-upsert-sql"><div class="inner"><span>postgres-upsert-sql</span></div></a></li><li class="depth-1"><a href="tech.v3.dataset.sql.html#var-result-set-.3Edataset"><div class="inner"><span>result-set-&gt;dataset</span></div></a></li><li class="depth-1"><a href="tech.v3.dataset.sql.html#var-result-set-.3Edataset-seq"><div class="inner"><span>result-set-&gt;dataset-seq</span></div></a></li><li class="depth-1"><a href="tech.v3.dataset.sql.html#var-result-set-metadata-.3Edata"><div class="inner"><span>result-set-metadata-&gt;data</span></div></a></li><li class="depth-1"><a href="tech.v3.dataset.sql.html#var-set-datatype-mapping.21"><div class="inner"><span>set-datatype-mapping!</span></div></a></li><li class="depth-1"><a href="tech.v3.dataset.sql.html#var-sql-.3Edataset"><div class="inner"><span>sql-&gt;dataset</span></div></a></li><li class="depth-1"><a href="tech.v3.dataset.sql.html#var-sql-.3Edataset-seq"><div class="inner"><span>sql-&gt;dataset-seq</span></div></a></li><li class="depth-1"><a href="tech.v3.dataset.sql.html#var-sql-server-connect-str"><div class="inner"><span>sql-server-connect-str</span></div></a></li><li class="depth-1"><a href="tech.v3.dataset.sql.html#var-table-exists.3F"><div class="inner"><span>table-exists?</span></div></a></li></ul></div><div class="namespace-docs" id="content"><h1 class="anchor" id="top">tech.v3.dataset.sql</h1><div class="doc"><div class="markdown"><p>Pathways to transform dataset to and from SQL databases.  Built directly on
java.sql interfaces.  Generically SQL doesn't support very many datatypes but
an effort has been made to enable database-specific support for these base datatypes:</p>
<ul>
<li>Integer Types - <code>:int16</code>, <code>:int32</code>, <code>:int64</code></li>
<li>Float Types - <code>:float32</code>, <code>:float64</code></li>
<li>String, Text</li>
<li>LocalDate (date), Instant (database specific, defaults to timestamp), LocalTime (time).</li>
<li>UUID (uuid in postgres, uniqueidentifier in sql server)</li>
</ul>
<p>Users can serialize result sets into one dataset or a sequence of datasets depending
on their downstream use case.</p>
<h2>Column Metadata For Writing To The Database</h2>
<p>For creating tables and uploading data to the database column metadata may be used
to extend how the system writes data.</p>
<ul>
<li><code>:sql-datatype</code> - Change the sql datatype used during create-table.  This string
will be written in verbatim into the create-table sql.</li>
<li><code>:column-&gt;sql</code> - pair of <em>integer</em> sql type and function that takes a column and row and
must return a datatype in the SQL space of <code>sql-datatype</code>.  To find the integer sql type
see the <a href="tech.v3.datatset.sql.datatypes">tech.v3.datatset.sql.datatypes</a> namespace or use <a href="tech.v3.dataset.sql.html#var-database-type-table">database-type-table</a> to find
the type table for your particular database.</li>
<li><code>:insert-sql</code> - When creating the prepared statement the default will be to use <code>?</code> but
users can override this to setup specialized types in the prepared statement.  For example
the postgres UUID type requires <code>? ::UUID</code> in order to correctly serialize.</li>
</ul>
<h2>Metadata For Reading A ResultSet</h2>
<p>When reading the result set the normal database option may be used such as <code>key-fn</code> and
<code>dataset-name</code>.  In addition, similar to parsing datasets via <code>-&gt;dataset</code> users can pass
in a keyed map as <code>:parser-fn</code> in which case the keys must match the post-key-fn'd
result column name.  Entries in <code>parser-fn</code> must be tuples of
<code>[datatype result-set-read-fn]</code> where <code>result-set-read-fn</code> takes a resultset and a column
index and returns data of the appropriate datatype.</p>
<p>If you are unsure of the datatype
you can return <code>nil</code> for the datatype and the system will divine the datatype to use
from the return value of <code>result-set-read-fn</code>.  This has the drawback that columns
with all missing values will be <code>:boolean</code> columns as per the dataset default and thus
this may break round-tripping.</p>
<pre><code class="language-clojure">
user&gt; (def stocks (-&gt; (ds/-&gt;dataset "https://github.com/techascent/tech.ml.dataset/raw/master/test/data/stocks.csv" {:key-fn keyword})
                      (vary-meta assoc
                                 :name "stocks"
                                 :primary-keys ["date" "symbol"])))

#'user/stocks
user&gt; (ds/head stocks)
stocks [5 3]:

| :symbol |      :date | :price |
|---------|------------|-------:|
|    MSFT | 2000-01-01 |  39.81 |
|    MSFT | 2000-02-01 |  36.35 |
|    MSFT | 2000-03-01 |  43.22 |
|    MSFT | 2000-04-01 |  28.37 |
|    MSFT | 2000-05-01 |  25.45 |
user&gt; (sql/table-exists? dev-conn stocks)
false
user&gt; (sql/create-table! dev-conn stocks)
nil
user&gt; (sql/table-exists? dev-conn stocks)
true
user&gt; (sql/insert-dataset! dev-conn stocks)
nil
user&gt; ;;Note the column names are now strings.
user&gt; (def sql-stocks (sql/sql-&gt;dataset dev-conn "Select * from stocks"))
#'user/sql-stocks
user&gt; (ds/head sql-stocks)
_unnamed [5 3]:

| symbol |       date | price |
|--------|------------|------:|
|   MSFT | 2000-01-01 | 39.81 |
|   MSFT | 2000-02-01 | 36.35 |
|   MSFT | 2000-03-01 | 43.22 |
|   MSFT | 2000-04-01 | 28.37 |
|   MSFT | 2000-05-01 | 25.45 |
user&gt; (ds/head (sql/sql-&gt;dataset dev-conn "Select * from stocks" {:key-fn keyword}))
_unnamed [5 3]:

| :symbol |      :date | :price |
|---------|------------|-------:|
|    MSFT | 2000-01-01 |  39.81 |
|    MSFT | 2000-02-01 |  36.35 |
|    MSFT | 2000-03-01 |  43.22 |
|    MSFT | 2000-04-01 |  28.37 |
|    MSFT | 2000-05-01 |  25.45 |
</code></pre>
</div></div><div class="public anchor" id="var-create-sql"><h3>create-sql</h3><div class="usage"><code>(create-sql conn-or-db-name dataset options)</code><code>(create-sql conn-or-db-name dataset)</code></div><div class="doc"><div class="markdown"><p>Return a create table statement for this datasets.  Datatype appropriate columns
will be created based on each column's metadata.</p>
<ul>
<li><code>conn-or-db-name</code> - Either a Connection object or a string database name to use to map
database-specific datatypes, such as UUID's, to the appropriate column datatype.</li>
<li><code>dataset</code> - dataset or sequence of column metadata maps each of which must contain
:name.  <code>dataset</code>'s metadata itself must contain a <code>:name</code> key.</li>
</ul>
<p>Options:</p>
<p>All options may be provided as metadata on the table itself.</p>
<ul>
<li><code>:table-name</code> - table name to use.</li>
<li><code>:primary-key</code> - Either a string or a sequence of strings indicating the primary key
clause.</li>
</ul>
<p>Column Metadata:</p>
<p>Column metadata must have :name.  Each column metadata map may have :sql-datatype in which
case this will be used unchangd or :datatype which will be matched against the database
name to decide the specific datatype to use.</p>
</div></div><div class="src-link"><a href="https://github.com/techascent/tech.ml.dataset.sql/blob/master/src/tech/v3/dataset/sql.clj#L419">view source</a></div></div><div class="public anchor" id="var-create-table.21"><h3>create-table!</h3><div class="usage"><code>(create-table! conn dataset options)</code><code>(create-table! conn dataset)</code></div><div class="doc"><div class="markdown"><p>Create a table.  Exception upon failure to drop the table.</p>
<ul>
<li>conn - java.sql.Connection</li>
<li>dataset - dataset to use.  The dataset-name will be used as the table-name and the
column names and datatypes will be used for the sql names and datatypes.</li>
</ul>
<p>The dataset's dataset-name will be used for the table and if the dataset's metadata
has a :primary-key member this will be interpreted as a sequence of column names
to be used as the primary key.</p>
<p>Options:</p>
<ul>
<li><code>:table-name</code> - set the name of the table to use.  Overrides the dataset metadata.</li>
<li><code>:primary-key</code> - Array of column names to use as the primary key of this table.
Overrides the dataset metadata.</li>
</ul>
</div></div><div class="src-link"><a href="https://github.com/techascent/tech.ml.dataset.sql/blob/master/src/tech/v3/dataset/sql.clj#L492">view source</a></div></div><div class="public anchor" id="var-database-name"><h3>database-name</h3><div class="usage"><code>(database-name conn)</code></div><div class="doc"><div class="markdown"><p>Return the database name for this connection.</p>
</div></div><div class="src-link"><a href="https://github.com/techascent/tech.ml.dataset.sql/blob/master/src/tech/v3/dataset/sql.clj#L132">view source</a></div></div><div class="public anchor" id="var-database-type-table"><h3>database-type-table</h3><div class="usage"><code>(database-type-table conn)</code></div><div class="doc"><div class="markdown"><p>Return table mapping sql datatype to sql datatype integer for all datatypes
this database supports.</p>
</div></div><div class="src-link"><a href="https://github.com/techascent/tech.ml.dataset.sql/blob/master/src/tech/v3/dataset/sql.clj#L146">view source</a></div></div><div class="public anchor" id="var-drop-table.21"><h3>drop-table!</h3><div class="usage"><code>(drop-table! conn dataset)</code></div><div class="doc"><div class="markdown"><p>Drop a table.  Exception upon failure to drop the table.</p>
<ul>
<li>conn - java.sql.Connection</li>
<li>dataset - string, keyword, symbol, or dataset</li>
</ul>
</div></div><div class="src-link"><a href="https://github.com/techascent/tech.ml.dataset.sql/blob/master/src/tech/v3/dataset/sql.clj#L540">view source</a></div></div><div class="public anchor" id="var-drop-table-when-exists.21"><h3>drop-table-when-exists!</h3><div class="usage"><code>(drop-table-when-exists! conn dataset)</code></div><div class="doc"><div class="markdown"><p>Drop the table indicated by this dataset if it exists.</p>
</div></div><div class="src-link"><a href="https://github.com/techascent/tech.ml.dataset.sql/blob/master/src/tech/v3/dataset/sql.clj#L549">view source</a></div></div><div class="public anchor" id="var-ensure-table.21"><h3>ensure-table!</h3><div class="usage"><code>(ensure-table! conn dataset options)</code><code>(ensure-table! conn dataset)</code></div><div class="doc"><div class="markdown"><p>Create a table if it does not exist.  See documentation for create-table!</p>
</div></div><div class="src-link"><a href="https://github.com/techascent/tech.ml.dataset.sql/blob/master/src/tech/v3/dataset/sql.clj#L556">view source</a></div></div><div class="public anchor" id="var-execute-prepared-statement-batches.21"><h3>execute-prepared-statement-batches!</h3><div class="usage"><code>(execute-prepared-statement-batches! conn stmt-or-sql dataset options)</code></div><div class="doc"><div class="markdown"><p>Internal method to, using a dataset, execute prepared statement batches
drawn from the rows of the dataset.  For this to work correctly, the
connection needs to have autoCommit set to false and the sql statement's datatypes need
to match the dataset datatypes.</p>
<p>See namespace documentation about column metadata and various options that may be
associated on a per-column basis to change the way data is uploaded.</p>
<ul>
<li>conn - java.sql.Connection</li>
<li>stmt-or-sql - Either a prepared statement or a string in which case
the connection's .prepareStatement method will be called.</li>
<li>dataset - dataset</li>
</ul>
<p>Options</p>
<ul>
<li>batch-size - integer, defaults to 1024</li>
</ul>
</div></div><div class="src-link"><a href="https://github.com/techascent/tech.ml.dataset.sql/blob/master/src/tech/v3/dataset/sql.clj#L646">view source</a></div></div><div class="public anchor" id="var-execute-update.21"><h3>execute-update!</h3><div class="usage"><code>(execute-update! conn sql)</code></div><div class="doc"><div class="markdown"><p>Executes the given SQL statement, which may be an INSERT, UPDATE, or DELETE statement or
an SQL statement that returns nothing, such as an SQL DDL statement.
This statement will be immediately committed.</p>
</div></div><div class="src-link"><a href="https://github.com/techascent/tech.ml.dataset.sql/blob/master/src/tech/v3/dataset/sql.clj#L473">view source</a></div></div><div class="public anchor" id="var-generic-column-.3Esql"><h3>generic-column-&gt;sql</h3><div class="usage"><code>(generic-column-&gt;sql col idx)</code></div><div class="doc"><div class="markdown"><p>Generic function that reads a value from a column.</p>
</div></div><div class="src-link"><a href="https://github.com/techascent/tech.ml.dataset.sql/blob/master/src/tech/v3/dataset/sql.clj#L176">view source</a></div></div><div class="public anchor" id="var-generic-sql-.3Ecolumn"><h3>generic-sql-&gt;column</h3><div class="usage"><code>(generic-sql-&gt;column rs sql-col-idx)</code></div><div class="doc"><div class="markdown"><p>Generic function that reads a column from a result set.</p>
</div></div><div class="src-link"><a href="https://github.com/techascent/tech.ml.dataset.sql/blob/master/src/tech/v3/dataset/sql.clj#L189">view source</a></div></div><div class="public anchor" id="var-insert-dataset.21"><h3>insert-dataset!</h3><div class="usage"><code>(insert-dataset! conn dataset options)</code><code>(insert-dataset! conn dataset)</code></div><div class="doc"><div class="markdown"><p>Insert a dataset into a table.  Column datatypes will be inferred from the
dataset datatypes or may be provided as metadata on each column.  See namespace
documentation for <code>:column-&gt;sql</code>.</p>
</div></div><div class="src-link"><a href="https://github.com/techascent/tech.ml.dataset.sql/blob/master/src/tech/v3/dataset/sql.clj#L716">view source</a></div></div><div class="public anchor" id="var-insert-sql"><h3>insert-sql</h3><div class="usage"><code>(insert-sql conn-or-db-name dataset options)</code><code>(insert-sql conn-or-db-name dataset)</code></div><div class="doc"><div class="markdown"></div></div><div class="src-link"><a href="https://github.com/techascent/tech.ml.dataset.sql/blob/master/src/tech/v3/dataset/sql.clj#L579">view source</a></div></div><div class="public anchor" id="var-make-convert-column-.3Esql"><h3>make-convert-column-&gt;sql</h3><div class="usage"><code>(make-convert-column-&gt;sql convert-fn)</code></div><div class="doc"><div class="markdown"></div></div><div class="src-link"><a href="https://github.com/techascent/tech.ml.dataset.sql/blob/master/src/tech/v3/dataset/sql.clj#L182">view source</a></div></div><div class="public anchor" id="var-make-convert-sql-.3Ecolumn"><h3>make-convert-sql-&gt;column</h3><div class="usage"><code>(make-convert-sql-&gt;column convert-fn)</code></div><div class="doc"><div class="markdown"></div></div><div class="src-link"><a href="https://github.com/techascent/tech.ml.dataset.sql/blob/master/src/tech/v3/dataset/sql.clj#L195">view source</a></div></div><div class="public anchor" id="var-postgre-sql-connect-str"><h3>postgre-sql-connect-str</h3><div class="usage"><code>(postgre-sql-connect-str hoststr database user pwd)</code></div><div class="doc"><div class="markdown"></div></div><div class="src-link"><a href="https://github.com/techascent/tech.ml.dataset.sql/blob/master/src/tech/v3/dataset/sql.clj#L120">view source</a></div></div><div class="public anchor" id="var-postgres-upsert-sql"><h3>postgres-upsert-sql</h3><div class="usage"><code>(postgres-upsert-sql conn-or-db-name dataset options)</code><code>(postgres-upsert-sql conn-or-db-name dataset)</code></div><div class="doc"><div class="markdown"></div></div><div class="src-link"><a href="https://github.com/techascent/tech.ml.dataset.sql/blob/master/src/tech/v3/dataset/sql.clj#L601">view source</a></div></div><div class="public anchor" id="var-result-set-.3Edataset"><h3>result-set-&gt;dataset</h3><div class="usage"><code>(result-set-&gt;dataset conn-or-db-name results options)</code><code>(result-set-&gt;dataset conn-or-db-name results)</code></div><div class="doc"><div class="markdown"><p>Given a result set return a dataset that serialized the entire resultset into
one dataset.  See options for <a href="tech.v3.dataset.sql.html#var-result-set-.3Edataset-seq">result-set-&gt;dataset-seq</a>.</p>
</div></div><div class="src-link"><a href="https://github.com/techascent/tech.ml.dataset.sql/blob/master/src/tech/v3/dataset/sql.clj#L862">view source</a></div></div><div class="public anchor" id="var-result-set-.3Edataset-seq"><h3>result-set-&gt;dataset-seq</h3><div class="usage"><code>(result-set-&gt;dataset-seq conn-or-db-name results options)</code><code>(result-set-&gt;dataset-seq conn-or-db-name results)</code></div><div class="doc"><div class="markdown"><p>Given a result set return a sequence of datasets.  Each dataset will be at most
<code>:batch-size</code> num-rows in length.  Note that the statement will stay open as long as
the lazy sequence isn't fully realized which means if you do not realize the sequence
you will leave a hanging statement open.  There is currently no way to prematurely
end the dataset sequence and close the sql statement via the public API.</p>
<p>Options:</p>
<ul>
<li><code>:batch-size</code> - defaults to 64000.  Returned datasets will be at most this number of
rows long.</li>
<li><code>:key-fn</code> - Apply this to the column names -- an example would be <code>keyword</code>.</li>
<li><code>:parser-fn</code> - Map of post-key-fn column-name to tuple of <code>[datatype result-set-read-fn]</code>
where result-set-read-fn takes a result-set and a column-index and must return data
of the appropriate datatype.  If the datatype is unknown then nil can be provided and the
dataset will use the widest datatype that will fit the returned data or <code>:boolean</code> if all
values are missing.</li>
<li><code>:statement</code> - The sql statement to close when finished.</li>
<li><code>:close?</code> - Close the result set when finished.  Defaults to true.</li>
</ul>
</div></div><div class="src-link"><a href="https://github.com/techascent/tech.ml.dataset.sql/blob/master/src/tech/v3/dataset/sql.clj#L818">view source</a></div></div><div class="public anchor" id="var-result-set-metadata-.3Edata"><h3>result-set-metadata-&gt;data</h3><div class="usage"><code>(result-set-metadata-&gt;data metadata col-idx)</code></div><div class="doc"><div class="markdown"><p>Given result set metadata and a column index return the metadata.  Note that the
result set metadata for a particular column is save as :result-set-metadata in the
column's metadata.</p>
</div></div><div class="src-link"><a href="https://github.com/techascent/tech.ml.dataset.sql/blob/master/src/tech/v3/dataset/sql.clj#L728">view source</a></div></div><div class="public anchor" id="var-set-datatype-mapping.21"><h3>set-datatype-mapping!</h3><div class="usage"><code>(set-datatype-mapping! database-name datatype sql-datatype sql-type-index result-set-read-fn col-read-fn)</code></div><div class="doc"><div class="markdown"><p>Add a database specific datatype mapping.</p>
<ul>
<li>`datatype-name - name of database</li>
<li><code>datatype</code> - dtype-next datatype</li>
<li><code>sql-datatype</code> - sql datatype to to map to.</li>
<li><code>sql-type-index</code> - type index to use to set missing.  See <a href="datatype-type-table">datatype-type-table</a>
for a way to find the sql type index from the sql datatype.</li>
<li><code>result-set-read-fn</code> - function that takes a result set and a column index and returns
the data in dtype-next space so for example returns a <code>java.time.LocalTime</code> object as opposed
to a <code>java.sql.Time</code> object.</li>
<li><code>col-read-fn</code> - Function takes a column and a row idx and returns data as an sql datatype</li>
</ul>
<ul>
<li>for instance a <code>java.sql.Time</code> object as opposed to a <code>java.time.LocalTime</code> object.</li>
</ul>
<p>Your type should be a proper tech.v3.datatype datatype meaning it is either an existing
datatype or added via tech.v3.datatype.casting/add-object-datatype!.</p>
<p>Example:</p>
<p>For our example let's say we would like to support postgreSQL's jsonb datatype.  We first
create a record type to denote json data and register it with dtype-next.  Next we build
a dataset with a column of this datatype.</p>
<p>Next we register a way to input and get back this data from sql.  After that columns of
the new datatype will be automatically marshalled into/out of sql.</p>
<pre><code class="language-clojure">user&gt; (def conn (tech.v3.dataset.sql-test-utils/connect :postgre-sql))
#'user/conn
user&gt; conn
#object[org.postgresql.jdbc.PgConnection 0x421726aa "org.postgresql.jdbc.PgConnection@421726aa"]
user&gt; (require '[tech.v3.dataset :as ds])
nil
user&gt; (require '[tech.v3.datatype.casting :as casting])
nil
user&gt; (require '[tech.v3.dataset.sql :as sql])
nil
user&gt; (require '[clojure.data.json :as json])
nil
user&gt; (defrecord JSONData [json-data])
JSONData
user&gt; (casting/add-object-datatype! :json-data JSONData)
:ok
user&gt; (def json-type-index (-&gt; (sql/database-type-table conn)
                              (ds/filter-column "TYPE_NAME" #(= % "jsonb"))
                              (ds/row-at -1)
                              (get "DATA_TYPE")))
#'user/json-type-index
user&gt; json-type-index
1111
user&gt; (sql/database-name conn)
"PostgreSQL"
user&gt; (sql/set-datatype-mapping!
       "PostgreSQL" :json-data "jsonb" json-type-index
       (fn [^java.sql.ResultSet rs col-idx]
         (when-let [json-obj (.getObject rs col-idx)]
           (-&gt; json-obj
               (str)
               (json/read-str :key-fn keyword)
               (JSONData.))))
       (fn [col idx]
         (when-let [col-obj (col idx)]
           (-&gt; col-obj
               (:json-data)
               (json/write-str)))))
:ok
user&gt; (def table-name "jsontable")
#'user/table-name
user&gt; (def test-ds (ds/-&gt;dataset {:jsoncol [(JSONData. {:a 1 :b 2})
                                            (JSONData. {:c 2 :d 3})]}
                                    {:dataset-name table-name}))
#'user/test-ds
user&gt; test-ds
jsontable [2 1]:

|                  :jsoncol |
|---------------------------|
| {:json-data {:a 1, :b 2}} |
| {:json-data {:c 2, :d 3}} |
user&gt; (test-ds :jsoncol)
#tech.v3.dataset.column&lt;json-data&gt;[2]
:jsoncol
[user.JSONData@db1bf962, user.JSONData@db1bf861]
user&gt; (sql/create-table! conn test-ds)
nil
user&gt; (sql/insert-dataset! conn test-ds)
nil
user&gt; (sql/sql-&gt;dataset conn (str "select * from " table-name)
                        {:key-fn keyword})
_unnamed [2 1]:

|                  :jsoncol |
|---------------------------|
| {:json-data {:a 1, :b 2}} |
| {:json-data {:c 2, :d 3}} |
</code></pre>
</div></div><div class="src-link"><a href="https://github.com/techascent/tech.ml.dataset.sql/blob/master/src/tech/v3/dataset/sql.clj#L233">view source</a></div></div><div class="public anchor" id="var-sql-.3Edataset"><h3>sql-&gt;dataset</h3><div class="usage"><code>(sql-&gt;dataset conn sql options)</code><code>(sql-&gt;dataset conn sql)</code></div><div class="doc"><div class="markdown"><p>Given a connection and an sql statement return a single dataset.
See options for <a href="tech.v3.dataset.sql.html#var-result-set-.3Edataset-seq">result-set-&gt;dataset-seq</a>.</p>
</div></div><div class="src-link"><a href="https://github.com/techascent/tech.ml.dataset.sql/blob/master/src/tech/v3/dataset/sql.clj#L892">view source</a></div></div><div class="public anchor" id="var-sql-.3Edataset-seq"><h3>sql-&gt;dataset-seq</h3><div class="usage"><code>(sql-&gt;dataset-seq conn sql options)</code><code>(sql-&gt;dataset-seq conn sql)</code></div><div class="doc"><div class="markdown"><p>Given a connection and an sql statement return a sequence of datasets.
See options for <a href="tech.v3.dataset.sql.html#var-result-set-.3Edataset-seq">result-set-&gt;dataset-seq</a>.</p>
</div></div><div class="src-link"><a href="https://github.com/techascent/tech.ml.dataset.sql/blob/master/src/tech/v3/dataset/sql.clj#L873">view source</a></div></div><div class="public anchor" id="var-sql-server-connect-str"><h3>sql-server-connect-str</h3><div class="usage"><code>(sql-server-connect-str hoststr database user pwd)</code></div><div class="doc"><div class="markdown"></div></div><div class="src-link"><a href="https://github.com/techascent/tech.ml.dataset.sql/blob/master/src/tech/v3/dataset/sql.clj#L126">view source</a></div></div><div class="public anchor" id="var-table-exists.3F"><h3>table-exists?</h3><div class="usage"><code>(table-exists? conn dataset)</code></div><div class="doc"><div class="markdown"><p>Test if a table exists.</p>
<ul>
<li>conn - java.sql.Connection</li>
<li>dataset - string, keyword, symbol, or dataset</li>
</ul>
<p>Example:</p>
<pre><code class="language-clojure">  user&gt; (sql/table-exists? dev-conn stocks)
  true
</code></pre>
</div></div><div class="src-link"><a href="https://github.com/techascent/tech.ml.dataset.sql/blob/master/src/tech/v3/dataset/sql.clj#L518">view source</a></div></div></div></body></html>